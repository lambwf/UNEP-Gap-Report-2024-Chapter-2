---
title: "UNEP-Gap-Report-2024-Countries"
author: "William F. Lamb"
date: "30 4 2024"
output: word_document
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = FALSE)

rm(list = ls())

library(tidyverse)
library(openxlsx)
library(countrycode)
library(ggrepel)
library(patchwork)
library(zoo)
library(RColorBrewer)
library(WDI)
library(labelled)
library(grid)

source("https://raw.githubusercontent.com/lambwf/Codebase/main/figure_style.R")
source("https://raw.githubusercontent.com/lambwf/Codebase/main/reshape_with_labels.R")
source("https://raw.githubusercontent.com/lambwf/Codebase/main/locate_shares.R")
source("https://raw.githubusercontent.com/lambwf/Codebase/main/load_gcb_countries_v2023.R")


```


```{r load_EDGAR}

## load EDGAR data (https://edgar.jrc.ec.europa.eu/dataset_ghg80)

data_edgar_co2_ffi <- read.xlsx("sources/IEA_EDGAR_CO2_1970_2022.xlsx",sheet=2,startRow = 10)
data_edgar_co2_ffi <- gather(data_edgar_co2_ffi,year,value,Y_1970:Y_2022)
data_edgar_co2_ffi$year <- gsub("Y_","",data_edgar_co2_ffi$year)
data_edgar_co2_ffi <- data_edgar_co2_ffi %>% 
  select(iso=Country_code_A3,country=Name,code=ipcc_code_2006_for_standard_report,code_description=ipcc_code_2006_for_standard_report_name,gas=Substance,fossil_bio,year,value)

data_edgar_ch4 <- read.xlsx("sources/EDGAR_CH4_1970_2022.xlsx",sheet=2,startRow = 10)
data_edgar_ch4 <- gather(data_edgar_ch4,year,value,Y_1970:Y_2022)
data_edgar_ch4$year <- gsub("Y_","",data_edgar_ch4$year)
data_edgar_ch4 <- data_edgar_ch4 %>% 
  select(iso=Country_code_A3,country=Name,code=ipcc_code_2006_for_standard_report,code_description=ipcc_code_2006_for_standard_report_name,gas=Substance,fossil_bio,year,value)

data_edgar_n2o <- read.xlsx("sources/EDGAR_N2O_1970_2022.xlsx",sheet=2,startRow = 10)
data_edgar_n2o <- gather(data_edgar_n2o,year,value,Y_1970:Y_2022)
data_edgar_n2o$year <- gsub("Y_","",data_edgar_n2o$year)
data_edgar_n2o <- data_edgar_n2o %>% 
  select(iso=Country_code_A3,country=Name,code=ipcc_code_2006_for_standard_report,code_description=ipcc_code_2006_for_standard_report_name,gas=Substance,fossil_bio,year,value)

data_edgar_fgas <- read.xlsx("sources/EDGAR_F-gases_1990_2022.xlsx",sheet=2,startRow = 10)
data_edgar_fgas <- gather(data_edgar_fgas,year,value,Y_1990:Y_2022)
data_edgar_fgas$year <- gsub("Y_","",data_edgar_fgas$year)
data_edgar_fgas <- data_edgar_fgas %>% 
  select(iso=Country_code_A3,country=Name,code=ipcc_code_2006_for_standard_report,code_description=ipcc_code_2006_for_standard_report_name,gas=Substance,fossil_bio,year,value)

data_edgar <- rbind(data_edgar_co2_ffi,data_edgar_ch4)
data_edgar <- rbind(data_edgar,data_edgar_n2o)
data_edgar <- rbind(data_edgar,data_edgar_fgas)


## join GWPs and calculate CO2e

gwps <- read.csv("https://raw.githubusercontent.com/openclimatedata/globalwarmingpotentials/main/globalwarmingpotentials.csv",skip = 9)

data_edgar$gas <- gsub("-","",data_edgar$gas)
data_edgar <- left_join(data_edgar,gwps %>% select(gas=Species,AR6GWP100)) %>% 
  mutate(AR6GWP100=ifelse(gas=="CO2",1,AR6GWP100))

# check all gwps joined
check <- data_edgar %>% filter(is.na(AR6GWP100))
check <- data_edgar %>% select(gas,AR6GWP100) %>% distinct()

data_edgar <- data_edgar %>% 
  mutate(value_gwp=value*AR6GWP100)


# list_fgases <- data.frame(gas=unique(data_edgar$gas))
# list_fgases <- list_fgases %>% 
#   mutate(group=ifelse(grepl("CFC",gas),"ODS F-gases",NA)) %>% 
#   mutate(group=ifelse(grepl("HCFC",gas),"ODS F-gases",group)) %>% 
#   mutate(group=ifelse(grepl("HFC",gas),"UNFCCC F-gases",group)) %>% 
#   mutate(group=ifelse(grepl("Halon",gas),"ODS F-gases",group)) %>% 
#   mutate(group=ifelse(grepl("NF3",gas),"UNFCCC F-gases",group)) %>% 
#   mutate(group=ifelse(grepl("SF6",gas),"UNFCCC F-gases",group)) #%>% 
#   mutate(group=ifelse(is.na(group),"UNFCCC F-gases",group))


list_fgases <- data_edgar %>% 
  select(gas) %>% 
  distinct() %>% 
  mutate(group=ifelse(gas=="CO2","CO2",NA)) %>% 
  mutate(group=ifelse(gas=="CH4","CH4",group)) %>% 
  mutate(group=ifelse(gas=="N2O","N2O",group)) %>% 
  mutate(group=ifelse(is.na(group),"Fgases",group))

data_edgar <- left_join(data_edgar,list_fgases,by="gas")
data_edgar <- data_edgar %>% 
  mutate(gas=group) %>% 
  group_by(iso,country,code,code_description,gas,year) %>% 
  summarise(value=sum(value_gwp,na.rm=TRUE))

# check global totals
check <- data_edgar %>% filter(year==2022) %>% group_by(gas) %>% summarise(value=sum(value,na.rm=T))


### aggregate sectors

write.xlsx(data_edgar %>% ungroup() %>% select(code,code_description) %>% distinct() %>% arrange(code),"cc_sectors.xlsx")
data_edgar <- left_join(data_edgar,read.xlsx("sources/cc_sectors.xlsx"))

data_edgar$gas <- as.factor(data_edgar$gas)
data_edgar$gas <- fct_relevel(data_edgar$gas,"CO2","CH4","N2O","Fgases")

data_edgar$sector <- as.factor(data_edgar$sector)
data_edgar$sector <- fct_reorder(data_edgar$sector,data_edgar$sector_order)

data_edgar <- data_edgar %>% 
  mutate(year=as.numeric(year)) %>% 
  group_by(iso,country,sector,sector_codes,subsector,gas,year) %>% 
  summarise(value=sum(value,na.rm=TRUE))


```
``` {r load_other_data}

## Population data from the World Bank

data_wdi_pop<-WDI(country = "all",indicator = "SP.POP.TOTL",start = 1970,end = 2022,extra=TRUE,language = "en")%>%
  select(iso3c, country, year, SP.POP.TOTL) %>%
  filter(!is.na(iso3c))

data_wdi_pop$population <- data_wdi_pop$SP.POP.TOTL
data_wdi_pop$iso <- data_wdi_pop$iso3c
data_wdi_pop<-data_wdi_pop %>% select(-SP.POP.TOTL,-iso3c)
# 
# load_gcb_countries_ffi <- function(sheet_ffi) {
#   
#   data_gcb_co2_ffi <- gather(sheet_ffi,country,value,-X1)
#   data_gcb_co2_ffi <- data_gcb_co2_ffi %>% 
#     rename(year=X1) %>% 
#     mutate(iso=countrycode(country,"country.name","iso3c",warn=FALSE))
#   
#   data_gcb_co2_ffi$iso[grepl("Türkiye",data_gcb_co2_ffi$country)] <- "TUR"
#   
#   data_gcb_co2_ffi <- data_gcb_co2_ffi %>% 
#     #mutate(iso=ifelse(country=="Netherlands Antilles","ANT",iso)) %>% 
#     #mutate(iso=ifelse(country=="Türkiye","TUR",iso)) %>% 
#     mutate(value=value/1000) %>% 
#     mutate(value=value*(44/12)) %>%
#     mutate(units="GtCO2") %>% 
#     select(country,iso,units,year,value) 
#   
#   return(data_gcb_co2_ffi) 
# }

## Global Carbon Project CO2 FFI (https://globalcarbonbudget.org/carbonbudget2023/)

data_gcb_co2_ffi <- load_gcb_countries_ffi(read.xlsx("sources/National_Fossil_Carbon_Emissions_2023v1.0.xlsx",sheet=2,startRow = 12))
data_gcb_co2_ffi$iso[grepl("Türkiye",data_gcb_co2_ffi$country)] <- "TUR"

## Global Carbon Project CO2 LUC (https://globalcarbonbudget.org/carbonbudget2023/)

data_gcb_co2_luc <- load_gcb_countries_luc(
  readxl::read_xlsx('Sources/National_LandUseChange_Carbon_Emissions_2023v1.0.xlsx',range="A8:GT182",sheet=2),
  readxl::read_xlsx('Sources/National_LandUseChange_Carbon_Emissions_2023v1.0.xlsx',range="A8:GT182",sheet=3),
  readxl::read_xlsx('Sources/National_LandUseChange_Carbon_Emissions_2023v1.0.xlsx',range="A8:GT182",sheet=4)
)
data_gcb_co2_luc$iso[grepl("Türkiye",data_gcb_co2_luc$country)] <- "TUR"

## Global Carbon Project CO2 consumption

sheet_ffi <- read.xlsx("sources/National_Fossil_Carbon_Emissions_2023v1.0.xlsx",sheet=3,startRow = 9)
data_gcb_co2_cons <- gather(sheet_ffi,country,value,-X1)
data_gcb_co2_cons <- data_gcb_co2_cons %>% 
  rename(year=X1) %>% 
  mutate(iso=countrycode(country,"country.name","iso3c",warn=FALSE))

data_gcb_co2_cons$iso[grepl("Türkiye",data_gcb_co2_cons$country)] <- "TUR"

data_gcb_co2_cons <- data_gcb_co2_cons %>%  
  mutate(value=value/1000) %>% 
  mutate(value=value*(44/12)) %>%
  mutate(units="GtCO2") %>% 
  select(country,iso,units,year,value) 
  
  


# # Note for coding simplicity I average the bookkeeping models at the national level, before aggregating to regions later on. Results would be slightly different if emissions were summed by model and region, then averaged. NAs ignored
# 
# 
# data_gcb_lulucf_ntl <- data_gcb_lulucf_ntl %>% 
#   group_by(country,year,units) %>% 
#   summarise(value=mean(value,na.rm=TRUE))
# 
# data_gcb_lulucf_ntl <- spread(data_gcb_lulucf_ntl,year,value)
# data_gcb_lulucf_ntl <- data_gcb_lulucf_ntl %>% 
#   mutate(iso=countrycode(country,"country.name","iso3c")) %>% 
#   mutate(iso=ifelse(country=="Netherlands Antilles","ANT",iso))


```

```{r calc_indicators}

## Total GHG emissions

data_indicators <- data_edgar %>% 
  filter(year==2022) %>% 
  group_by(iso,country) %>% 
  summarise(ghg_total=sum(value,na.rm=TRUE)/1e3)

## Per capita GHG emissions

data_indicators <- left_join(data_indicators,data_wdi_pop %>% filter(year==2022) %>% select(iso,population),by = join_by(iso))
data_indicators <- data_indicators %>% 
  mutate(ghg_per_capita=ghg_total/population*1e6)

## Consumption based per capita emissions

data_indicators <- left_join(data_indicators,data_gcb_co2_cons %>% filter(year==2021) %>% group_by(iso) %>% summarise(co2_consumption=sum(value)),by = join_by(iso))
data_indicators <- data_indicators %>% 
  mutate(co2_cons_per_capita=co2_consumption/population*1e9)

## Historic cumulative emissions

data_indicators <- left_join(data_indicators,data_gcb_co2_ffi %>% group_by(iso) %>% summarise(co2_ffi_historic=sum(value,na.rm=TRUE)))
data_indicators <- left_join(data_indicators,data_gcb_co2_luc %>% group_by(iso) %>% summarise(co2_luc_historic=sum(mean,na.rm=TRUE)))
data_indicators <- data_indicators %>% 
  mutate(co2_historic =sum(co2_ffi_historic,co2_luc_historic,na.rm=T))


data_indicators <- data_indicators %>% 
  set_variable_labels(ghg_total="MtCO2e",
                      ghg_per_capita="tCO2e/person",
                      co2_consumption="GtCO2",
                      co2_cons_per_capita="tCO2/person",
                      co2_ffi_historic="GtCO2",
                      co2_luc_historic="GtCO2",
                      co2_historic="GtCO2")



data_indicators <- gather_with_labels(data_indicators,c("ghg_total","ghg_per_capita","co2_cons_per_capita","co2_historic"))

data_indicators <- data_indicators %>% 
  rename(units=label) %>% 
  mutate(label=ifelse(var=="ghg_total","Total GHG emissions in 2022:",NA)) %>% 
  mutate(label=ifelse(var=="ghg_per_capita","Per capita GHG emissions in 2022:",label)) %>% 
  mutate(label=ifelse(var=="co2_cons_per_capita","Per capita CO2 consumption in 2021:",label)) %>% 
  mutate(label=ifelse(var=="co2_historic","Historic CO2 emissions from 1850:",label))

data_indicators <- data_indicators %>% 
  mutate(value=ifelse(var=="ghg_total",signif(value,3),value)) %>% 
  mutate(value=ifelse(var=="ghg_per_capita",signif(value,3),value)) %>% 
  mutate(value=ifelse(var=="co2_cons_per_capita",signif(value,3),value)) %>% 
  mutate(value=ifelse(var=="co2_historic",signif(value,3),value))

data_indicators <- data_indicators %>% 
  mutate(value=paste0(value," ",units))


```

```{r plot_countries}

country_iso=c("CHN")

plot_country <- function(country_iso,data_edgar,data_indicators) {
  
  ## GHG emissions trend plot
  
  data_countries <- data_edgar %>% 
    filter(iso==country_iso) %>% 
    filter(year>=1990) %>% 
    group_by(iso,country,sector,sector_codes,year) %>%
    summarise(value=sum(value,na.rm=TRUE)/1e3)
  
  my_colours <- more_set2_colors(length(unique(data_countries$sector)))
  
  p1 <- data_countries %>% ggplot(aes(x=year,y=value,fill=sector)) +
    geom_area(color="#636363") +
    theme_wl() +
    scale_fill_manual(values = my_colours) +
    ylab("GHG Emissions (MtCO2e/year)") +
    theme(axis.title.x = element_blank(),
          panel.grid.major.x = element_blank(),
          panel.border = element_blank(),
          axis.line.x=element_line(colour='#636363'),
          axis.line.y=element_line(colour='#636363'),
          legend.position = "none",panel.background = element_blank())
  
  
  # data_countries_labels <- data_countries %>% 
  #   group_by(year,sector) %>% 
  #   summarise(value=sum(value,na.rm=TRUE))
  # data_countries_labels <- locate_shares(data_countries_labels,"sector",2022)
  # data_countries_labels <- data_countries %>% 
  #   filter(year==2022) %>% 
  #   arrange(desc(sector)) %>% 
  #   group_by(year) %>% 
  #   mutate(cumsum=cumsum(value)) %>% 
  #   ungroup() %>% 
  #   mutate(position=value/2) %>% 
  #   arrange(sector) %>% 
  #   mutate(location=cumsum-position)
  
  # p2 <- data_countries_labels %>%
  #   ggplot(.,aes(x=1,y=location,label=str_wrap(sector,18),color=sector)) +
  #   geom_text_repel(
  #     nudge_x      = 0.25,
  #     direction    = "y",
  #     hjust        = 1,
  #     segment.size = 0.2,
  #     size=3.75
  #   ) +
  #   geom_blank(data=data_countries %>% filter(year==2022) %>% group_by(year) %>% summarise(value=sum(value)),inherit.aes=FALSE,aes(x=1,y=value)) +
  #   theme_wl() +
  #   #expand_limits(x = 0, y = 0) +
  #   scale_color_manual(values = my_colours) + 
  #     theme(axis.title = element_blank(),
  #         panel.border = element_blank(),
  #         legend.position="none",
  #         axis.text.x = element_blank(),
  #         axis.text.y = element_blank(),
  #         axis.ticks = element_blank(),
  #         panel.grid.major = element_blank(),
  #         plot.background = element_blank(),
  #         plot.margin = unit(c(0,0,0,0),"cm"))
  
  # labels <- data_countries_labels %>% 
  #   select(sector) %>% 
  #   distinct() %>% 
  #   add_row(sector="Energy",.before=1) %>% 
  #   mutate(position_b=1) %>% 
  #   mutate(position_b=cumsum(position_b)) %>% 
  #   mutate(sector=as.factor(sector))
  # 
  # labels$sector <- fct_reorder(labels$sector,labels$position_b)
  # labels <- left_join(labels,data_countries_labels %>% select(sector,position_a=location))
  
  
  ## legend for the ghg trend plot
  
  labels <- data_countries %>% 
    ungroup() %>% 
    select(sector) %>% 
    distinct() %>% 
    add_row(sector="Energy",.before=1) %>% 
    mutate(position_b=1) %>% 
    mutate(position_b=cumsum(position_b)) %>% 
    mutate(sector=as.factor(sector))
  
  labels$sector <- fct_reorder(labels$sector,labels$position_b)
  
  labels <- labels %>% 
    mutate(label=as.character(sector)) %>% 
    mutate(label=ifelse(label %in% c("Power sector","Fossil production","Buildings","Transport","Industry"),paste0("  ",label),label)) %>% 
    arrange(desc(sector)) %>% 
    mutate(position_b=1) %>% 
    mutate(position_b=cumsum(position_b))
  
  p2 <- labels %>%  ggplot(.,aes(y=position_b,label=label)) +
    geom_point(aes(x=ifelse(sector %in% c("Power sector","Fossil production","Transport","Buildings","Industry"),2,1.9),fill=sector),
               shape=22,size=3,color='#636363') +
    geom_text(hjust=0,aes(x=2.1),color='#636363',vjust=0.5) +
    theme_wl() +
    scale_color_manual(values = c("white",my_colours)) +
    scale_fill_manual(values = c("white",my_colours)) +
    scale_x_continuous(limits=c(1.9,4)) +
    theme(axis.title = element_blank(),
          panel.border = element_blank(),
          legend.position="none",
          axis.text.x = element_blank(),
          axis.text.y = element_blank(),
          axis.ticks = element_blank(),
          panel.grid.major = element_blank(),
          plot.background = element_blank(),
          plot.margin = unit(c(0,0,0,0),"cm"))
  
  ## indicators plot
  
  p3 <- data_indicators %>% 
    filter(iso==country_iso) %>% 
    ggplot(.,aes(x=1,y=label,label=value)) +
    geom_text(size=10*(0.36),hjust=0,vjust=1,color='#636363')  +
    scale_y_discrete(labels = function(x) str_wrap(x, width = 20))+
    scale_x_continuous(limits=c(1,3)) +
    theme_wl()+
    theme(axis.title = element_blank(),
          axis.ticks = element_blank(),
          panel.background = element_blank(),
          panel.border = element_blank(),
          panel.grid = element_blank(),
          axis.text.x = element_blank(),
          axis.text.y = element_text(size=10))
  
  name <- countrycode(sourcevar = country_iso,origin="iso3c","country.name")
  
  p <- p1 + p2 + plot_spacer() + (p3 /plot_spacer() + plot_layout(heights=c(4,1))) + plot_layout(widths=c(4.5,2,0.1,2)) +
    plot_annotation(title=name,theme=theme_wl() + theme(plot.title=element_text(vjust=1,size=16),plot.background = element_rect(fill = NA, colour = '#636363', size = 0.5)))
  
  
  return(p)
  
  
  
}

```

```{r plots, fig.width=10,fig.height=4}

countries <- data_indicators %>% filter(!is.na(population)) %>% filter(!is.na(co2_consumption)) %>% select(iso) %>% distinct()
countries <- countries %>% 
  mutate(country=countrycode(iso,"iso3c","country.name"))

for (i in 1:length(countries$iso)) {
  
  ggsave(plot_country(countries$iso[i],data_edgar,data_indicators),filename = paste0(countries$country[i],".png"),path = "results/countries/",device = "png",height = 4,width=10,dpi=300) 
  ggsave(plot_country(countries$iso[i],data_edgar,data_indicators),filename = paste0(countries$country[i],".pdf"),path = "results/countries/",device = "pdf",height = 4,width=10) 
  
  
}


#plot_country(countries$iso[i],data_edgar,data_indicators)



```

```{r asd, fig.width=10,fig.height=12, fig.path="results/countries/",dev=c('png','pdf','svg')}

wrap_elements(plot_country("CHN",data_edgar,data_indicators)) /wrap_elements(plot_country("USA",data_edgar,data_indicators)) / wrap_elements(plot_country("RUS",data_edgar,data_indicators))

```



``` {r save}

metadata <- labelled::generate_dictionary(data_indicators) %>% 
  select(variable,units=label)



```
