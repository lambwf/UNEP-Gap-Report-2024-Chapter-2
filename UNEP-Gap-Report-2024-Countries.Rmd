---
title: "UNEP-Gap-Report-2024-Countries"
author: "William F. Lamb"
date: "30 4 2024"
output: word_document
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = FALSE)

rm(list = ls())

library(tidyverse)
library(openxlsx)
library(countrycode)
library(ggrepel)
library(patchwork)
library(zoo)
library(RColorBrewer)
library(WDI)
library(labelled)
library(grid)

source("https://raw.githubusercontent.com/lambwf/Codebase/main/figure_style.R")
source("https://raw.githubusercontent.com/lambwf/Codebase/main/reshape_with_labels.R")
source("https://raw.githubusercontent.com/lambwf/Codebase/main/locate_shares.R")
source("https://raw.githubusercontent.com/lambwf/Codebase/main/load_gcb_countries_v2023.R")


cc_EU <- read.csv("https://raw.githubusercontent.com/openclimatedata/countrygroups/main/data/european-union.csv") %>% 
  select(iso=Code) %>% 
  mutate(EU="EU27")


```


```{r load_EDGAR}

## load EDGAR data (https://edgar.jrc.ec.europa.eu/dataset_ghg80)

data_edgar_co2_ffi <- read.xlsx("sources/IEA_EDGAR_CO2_1970_2022.xlsx",sheet=2,startRow = 10)
data_edgar_co2_ffi <- gather(data_edgar_co2_ffi,year,value,Y_1970:Y_2022)
data_edgar_co2_ffi$year <- gsub("Y_","",data_edgar_co2_ffi$year)
data_edgar_co2_ffi <- data_edgar_co2_ffi %>% 
  select(iso=Country_code_A3,country=Name,code=ipcc_code_2006_for_standard_report,code_description=ipcc_code_2006_for_standard_report_name,gas=Substance,fossil_bio,year,value)

data_edgar_ch4 <- read.xlsx("sources/EDGAR_CH4_1970_2022.xlsx",sheet=2,startRow = 10)
data_edgar_ch4 <- gather(data_edgar_ch4,year,value,Y_1970:Y_2022)
data_edgar_ch4$year <- gsub("Y_","",data_edgar_ch4$year)
data_edgar_ch4 <- data_edgar_ch4 %>% 
  select(iso=Country_code_A3,country=Name,code=ipcc_code_2006_for_standard_report,code_description=ipcc_code_2006_for_standard_report_name,gas=Substance,fossil_bio,year,value)

data_edgar_n2o <- read.xlsx("sources/EDGAR_N2O_1970_2022.xlsx",sheet=2,startRow = 10)
data_edgar_n2o <- gather(data_edgar_n2o,year,value,Y_1970:Y_2022)
data_edgar_n2o$year <- gsub("Y_","",data_edgar_n2o$year)
data_edgar_n2o <- data_edgar_n2o %>% 
  select(iso=Country_code_A3,country=Name,code=ipcc_code_2006_for_standard_report,code_description=ipcc_code_2006_for_standard_report_name,gas=Substance,fossil_bio,year,value)

data_edgar_fgas <- read.xlsx("sources/EDGAR_F-gases_1990_2022.xlsx",sheet=2,startRow = 10)
data_edgar_fgas <- gather(data_edgar_fgas,year,value,Y_1990:Y_2022)
data_edgar_fgas$year <- gsub("Y_","",data_edgar_fgas$year)
data_edgar_fgas <- data_edgar_fgas %>% 
  select(iso=Country_code_A3,country=Name,code=ipcc_code_2006_for_standard_report,code_description=ipcc_code_2006_for_standard_report_name,gas=Substance,fossil_bio,year,value)

data_edgar <- rbind(data_edgar_co2_ffi,data_edgar_ch4)
data_edgar <- rbind(data_edgar,data_edgar_n2o)
data_edgar <- rbind(data_edgar,data_edgar_fgas)
data_edgar$year <- as.numeric(data_edgar$year)

## join GWPs and calculate CO2e

gwps <- read.csv("https://raw.githubusercontent.com/openclimatedata/globalwarmingpotentials/main/globalwarmingpotentials.csv",skip = 9)

data_edgar$gas <- gsub("-","",data_edgar$gas)
data_edgar <- left_join(data_edgar,gwps %>% select(gas=Species,AR6GWP100)) %>% 
  mutate(AR6GWP100=ifelse(gas=="CO2",1,AR6GWP100))

# check all gwps joined
check <- data_edgar %>% filter(is.na(AR6GWP100))
check <- data_edgar %>% select(gas,AR6GWP100) %>% distinct()

data_edgar <- data_edgar %>% 
  mutate(value_gwp=value*AR6GWP100)


# list_fgases <- data.frame(gas=unique(data_edgar$gas))
# list_fgases <- list_fgases %>% 
#   mutate(group=ifelse(grepl("CFC",gas),"ODS F-gases",NA)) %>% 
#   mutate(group=ifelse(grepl("HCFC",gas),"ODS F-gases",group)) %>% 
#   mutate(group=ifelse(grepl("HFC",gas),"UNFCCC F-gases",group)) %>% 
#   mutate(group=ifelse(grepl("Halon",gas),"ODS F-gases",group)) %>% 
#   mutate(group=ifelse(grepl("NF3",gas),"UNFCCC F-gases",group)) %>% 
#   mutate(group=ifelse(grepl("SF6",gas),"UNFCCC F-gases",group)) #%>% 
#   mutate(group=ifelse(is.na(group),"UNFCCC F-gases",group))


list_fgases <- data_edgar %>% 
  select(gas) %>% 
  distinct() %>% 
  mutate(group=ifelse(gas=="CO2","CO2",NA)) %>% 
  mutate(group=ifelse(gas=="CH4","CH4",group)) %>% 
  mutate(group=ifelse(gas=="N2O","N2O",group)) %>% 
  mutate(group=ifelse(is.na(group),"Fgases",group))

data_edgar <- left_join(data_edgar,list_fgases,by="gas")
data_edgar <- data_edgar %>% 
  mutate(gas=group) %>% 
  group_by(iso,country,code,code_description,gas,year) %>% 
  summarise(value=sum(value_gwp,na.rm=TRUE))

## Gg to tons
data_edgar$value = data_edgar$value*1000

# check global totals
check <- data_edgar %>% filter(year==2022) %>% group_by(gas) %>% summarise(value=sum(value,na.rm=T))



## Grassi et al. LULUCF data (https://zenodo.org/records/7190601)

data_lulucf <- read.xlsx('sources/LULUCF NGHGI database August 2022.xlsx',sheet=7,startRow = 5)
data_lulucf <- data_lulucf %>% 
  rename(country=X1) %>%
  mutate(iso=countrycode(country,"country.name","iso3c"))
data_lulucf <- gather(data_lulucf,year,value,-country,-iso)
data_lulucf <- data_lulucf %>% 
  mutate(year=as.numeric(year)) %>% 
  filter(!is.na(year)) %>% 
  mutate(value=as.numeric(value)) %>% 
  mutate(value=value*1e6) %>% 
  mutate(code="3B") %>% 
  mutate(code_description="Land use change") %>% 
  mutate(gas="CO2") %>% 
  select(iso,country,code,code_description,gas,year,value) 

data_ghg <- rbind(data_edgar,data_lulucf)


### consistent names

newnames <- data_ghg %>% 
  ungroup() %>% 
  select(iso) %>% 
  distinct() %>% 
  mutate(newname=countrycode(iso,"iso3c","country.name")) %>% 
  mutate(newname=ifelse(iso=="AIR","Intl. Aviation",newname)) %>% 
  mutate(newname=ifelse(iso=="SEA","Intl. Shipping",newname)) %>% 
  mutate(newname=ifelse(iso=="SCG","Serbia and Montenegro",newname)) %>% 
  mutate(newname=ifelse(iso=="ANT","Netherlands Antilles",newname))

data_ghg <- left_join(data_ghg,newnames,by="iso") %>% 
  mutate(country=newname) %>% 
  select(-newname) %>% 
  filter(!is.na(iso))


### aggregate sectors

write.xlsx(data_ghg %>% ungroup() %>% select(code,code_description) %>% distinct() %>% arrange(code),"cc_sectors.xlsx")
data_ghg <- left_join(data_ghg,read.xlsx("sources/cc_sectors.xlsx"),by=join_by(code, code_description))

data_ghg$gas <- as.factor(data_ghg$gas)
data_ghg$gas <- fct_relevel(data_ghg$gas,"CO2","CH4","N2O","Fgases")

data_ghg$sector_tier_2 <- as.factor(data_ghg$sector_tier_2)
data_ghg$sector_tier_2 <- fct_reorder(data_ghg$sector_tier_2,data_ghg$sector_tier_2_order)


data_ghg <- data_ghg %>% 
  mutate(year=as.numeric(year)) %>% 
  group_by(iso,country,sector_tier_1,sector_tier_2,sector_tier_2_codes,sector_tier_3,gas,year) %>% 
  summarise(value=sum(value,na.rm=TRUE))


## aggregate EU
data_ghg_eu <- left_join(data_ghg,cc_EU,by="iso") %>%
  filter(!is.na(EU)) %>% 
  mutate(iso="EU27") %>% 
  select(-EU) %>%
  mutate(country="European Union") %>% 
  group_by(iso,country,sector_tier_1,sector_tier_2,sector_tier_2_codes,sector_tier_3,gas,year) %>% 
  summarise(value=sum(value,na.rm=T))

data_ghg <- rbind(data_ghg,data_ghg_eu)



```

``` {r load_other_data}

## Population data from the World Bank

data_wdi_pop<-WDI(country = "all",indicator = "SP.POP.TOTL",start = 1970,end = 2022,extra=TRUE,language = "en")%>%
  select(iso3c, country, year, SP.POP.TOTL) %>%
  filter(!is.na(iso3c))

data_wdi_pop$population <- data_wdi_pop$SP.POP.TOTL
data_wdi_pop$iso <- data_wdi_pop$iso3c
data_wdi_pop<-data_wdi_pop %>% select(-SP.POP.TOTL,-iso3c)


## Global Carbon Project CO2 FFI (https://globalcarbonbudget.org/carbonbudget2023/)

data_gcb_co2_ffi <- load_gcb_countries_ffi(read.xlsx("sources/National_Fossil_Carbon_Emissions_2023v1.0.xlsx",sheet=2,startRow = 12))
data_gcb_co2_ffi$iso[grepl("Türkiye",data_gcb_co2_ffi$country)] <- "TUR"


## Global Carbon Project CO2 LUC (https://globalcarbonbudget.org/carbonbudget2023/)

data_gcb_co2_luc <- load_gcb_countries_luc(
  readxl::read_xlsx('sources/National_LandUseChange_Carbon_Emissions_2023v1.0.xlsx',range="A8:GT182",sheet=2),
  readxl::read_xlsx('sources/National_LandUseChange_Carbon_Emissions_2023v1.0.xlsx',range="A8:GT182",sheet=3),
  readxl::read_xlsx('sources/National_LandUseChange_Carbon_Emissions_2023v1.0.xlsx',range="A8:GT182",sheet=4)
)
data_gcb_co2_luc$iso[grepl("Türkiye",data_gcb_co2_luc$country)] <- "TUR"


## Global Carbon Project CO2 consumption

sheet_ffi <- read.xlsx("sources/National_Fossil_Carbon_Emissions_2023v1.0.xlsx",sheet=3,startRow = 9)
data_gcb_co2_cons <- gather(sheet_ffi,country,value,-X1)
data_gcb_co2_cons <- data_gcb_co2_cons %>% 
  rename(year=X1) %>% 
  mutate(iso=countrycode(country,"country.name","iso3c",warn=FALSE))

data_gcb_co2_cons$iso[grepl("Türkiye",data_gcb_co2_cons$country)] <- "TUR"

data_gcb_co2_cons <- data_gcb_co2_cons %>%  
  mutate(value=value/1000) %>% 
  mutate(value=value*(44/12)) %>%
  mutate(units="GtCO2") %>% 
  select(country,iso,units,year,value) 




```

```{r calc_indicators}

## Total GHG emissions

data_indicators <- data_edgar %>% 
  filter(year==2022) %>% 
  group_by(iso,country) %>% 
  summarise(ghg_total=sum(value,na.rm=TRUE)/1e6)


## Population

data_indicators <- left_join(data_indicators,data_wdi_pop %>% filter(year==2022) %>% select(iso,population),by = join_by(iso))


## Consumption based emissions

data_indicators <- left_join(data_indicators,data_gcb_co2_cons %>% filter(year==2021) %>% group_by(iso) %>% summarise(co2_consumption=sum(value)),by = join_by(iso))


## Historic cumulative emissions

data_indicators <- left_join(data_indicators,data_gcb_co2_ffi %>% group_by(iso) %>% summarise(co2_ffi_historic=sum(value,na.rm=TRUE)))
data_indicators <- left_join(data_indicators,data_gcb_co2_luc %>% group_by(iso) %>% summarise(co2_luc_historic=sum(mean,na.rm=TRUE)))
data_indicators <- data_indicators %>% 
  mutate(co2_historic =sum(co2_ffi_historic,co2_luc_historic,na.rm=T))


## join EU

data_indicators_eu <- left_join(data_indicators,cc_EU,by="iso") %>% 
  filter(!is.na(EU)) %>% 
  mutate(iso=EU) %>% 
  select(-EU)
data_indicators_eu <- gather(data_indicators_eu,var,value,-iso,-country) %>% 
  group_by(iso,var) %>% 
  summarise(value=sum(value,na.rm=TRUE)) %>% 
  mutate(country="European Union")
data_indicators <- rbind(data_indicators,spread(data_indicators_eu,var,value))


## calculate per capita values

data_indicators <- data_indicators %>% 
  mutate(ghg_per_capita=ghg_total/population*1e6) %>% 
  mutate(co2_cons_per_capita=co2_consumption/population*1e9)


## label indicators

data_indicators <- data_indicators %>% 
  set_variable_labels(population="Population",
                      ghg_total="MtCO2e",
                      ghg_per_capita="tCO2e/person",
                      co2_consumption="GtCO2",
                      co2_cons_per_capita="tCO2/person",
                      co2_ffi_historic="GtCO2",
                      co2_luc_historic="GtCO2",
                      co2_historic="GtCO2")



data_indicators <- gather_with_labels(data_indicators,c("ghg_total","ghg_per_capita","co2_cons_per_capita","co2_historic"))

data_indicators <- data_indicators %>% 
  rename(units=label) %>% 
  mutate(label=ifelse(var=="ghg_total","Total GHG emissions in 2022:",NA)) %>% 
  mutate(label=ifelse(var=="ghg_per_capita","Per capita GHG emissions in 2022:",label)) %>% 
  mutate(label=ifelse(var=="co2_cons_per_capita","Per capita CO2 consumption in 2021:",label)) %>% 
  mutate(label=ifelse(var=="co2_historic","Historic CO2 emissions from 1850:",label))

data_indicators <- data_indicators %>% 
  mutate(value=ifelse(var=="ghg_total",signif(value,3),value)) %>% 
  mutate(value=ifelse(var=="ghg_per_capita",signif(value,3),value)) %>% 
  mutate(value=ifelse(var=="co2_cons_per_capita",signif(value,3),value)) %>% 
  mutate(value=ifelse(var=="co2_historic",signif(value,3),value))

data_indicators <- data_indicators %>% 
  mutate(value=paste0(value," ",units))


```

```{r plot_countries}

plot_country <- function(country_iso,data_ghg,data_indicators) {
  
  ## GHG emissions trend plot
  
  data_countries <- data_ghg %>% 
    filter(iso==country_iso) %>% 
    filter(year>=1990) %>% 
    rename(sector=sector_tier_2) %>% 
    group_by(iso,country,sector,year) %>%
    summarise(value=sum(value,na.rm=TRUE)/1e6)
  
  
  labels <- read.xlsx("sources/cc_sectors.xlsx",sheet=2)
  labels <- labels %>% 
    arrange(desc(position)) %>% 
    mutate(position=1) %>% 
    mutate(position=cumsum(position))
  
  labels$sector <- fct_reorder(labels$sector,labels$position)
  
  
  data_countries$sector <- fct_relevel(data_countries$sector,"LULUCF")
  my_colours <- labels %>% select(sector,colour)
  my_colours$sector <- gsub("   ","",my_colours$sector)
  my_colours <- left_join(data_countries %>% 
                            ungroup() %>% 
                            select(sector) %>% 
                            distinct() %>% 
                            arrange(sector),my_colours)
  
  p1 <- data_countries %>% ggplot(aes(x=year,y=value,fill=sector)) +
    geom_area(color="#636363") +
    theme_wl() +
    scale_fill_manual(values = my_colours$colour) +
    ylab("GHG Emissions (MtCO2e/year)") +
    theme(axis.title.x = element_blank(),
          panel.grid.major.x = element_blank(),
          panel.border = element_blank(),
          axis.line.x=element_line(colour='#636363'),
          axis.line.y=element_line(colour='#636363'),
          legend.position = "none",panel.background = element_blank())
  
  
  p2 <- labels %>%  ggplot(.,aes(y=position,label=sector)) +
    geom_point(aes(x=ifelse(sector %in% c("Energy","Industrial processes","AFOLU","Waste & Other"),1.9,2),fill=sector),
               shape=22,size=3,color='#636363') +
    geom_text(hjust=0,aes(x=2.1),color='#636363',vjust=0.5) +
    geom_vline(xintercept = 4,color='#636363') +
    theme_wl() +
    #scale_color_manual(values = c("white",'#636363','#636363','#636363','#636363','#636363','#636363','#636363','#636363','#636363','#636363')) +
    scale_fill_manual(values = c(labels$colour)) +
    scale_x_continuous(limits=c(1.9,4)) +
    theme(axis.title = element_blank(),
          panel.border = element_blank(),
          legend.position="none",
          axis.text.x = element_blank(),
          axis.text.y = element_blank(),
          axis.ticks = element_blank(),
          panel.grid.major = element_blank(),
          plot.background = element_blank(),
          plot.margin = unit(c(0,0,0,0),"cm"))
  
  ## indicators plot
  
  p3 <- data_indicators %>% 
    ungroup() %>% 
    filter(iso==country_iso) %>%
    add_row(var="empty",label="",value="") %>% 
    ggplot(.,aes(x=1,y=label,label=value)) +
    geom_text(size=10*(0.36),hjust=0,vjust=1,color='#636363')  +
    scale_y_discrete(labels = function(x) str_wrap(x, width = 20))+
    scale_x_continuous(limits=c(1,3)) +
    theme_wl()+
    theme(axis.title = element_blank(),
          axis.ticks = element_blank(),
          panel.background = element_blank(),
          panel.border = element_blank(),
          panel.grid = element_blank(),
          axis.text.x = element_blank(),
          axis.text.y = element_text(size=10),
          plot.caption = element_text(size=11,colour='#bdbdbd',hjust=1)) +
    labs(caption='Sources: EDGAR | GCB | Grassi et al.')
  
  
  if (country_iso=="EU27") { name = "European Union"}
  else {name <- countrycode(sourcevar = country_iso,origin="iso3c","country.name")}
  
  p <- p1 + p2 + wrap_elements(p3) + plot_layout(widths=c(4.4,2.4,3.8)) +
    plot_annotation(title=name,
                    subtitle="Emissions trends and indicators",
                    #caption = 'Sources: EDGAR | GCB | Grassi et al.',
                    theme = theme_wl() + 
                      theme(plot.title=element_text(vjust=1,size=16),
                            plot.background = element_rect(fill = NA, colour = '#636363', size = 0.5),
                            plot.caption = element_text(size=11,colour='#bdbdbd',hjust=1)))
  
  
  return(p)
  
  
  
}

```

```{r plot_country_no_subheadings}

plot_country_no_subheadings <- function(country_iso,data_ghg,data_indicators) {
  
  ## GHG emissions trend plot
  
  data_countries <- data_ghg %>% 
    filter(iso==country_iso) %>% 
    filter(year>=1990) %>% 
    rename(sector=sector_tier_2) %>% 
    group_by(iso,country,sector,year) %>%
    summarise(value=sum(value,na.rm=TRUE)/1e6)
  
  
  labels <- read.xlsx("sources/cc_sectors.xlsx",sheet=2)
  labels <- labels %>% 
    arrange(desc(position)) %>% 
    mutate(position=1) %>% 
    mutate(position=cumsum(position))
  
  labels$sector <- fct_reorder(labels$sector,labels$position)
  
  
  data_countries$sector <- fct_relevel(data_countries$sector,"LULUCF")
  my_colours <- labels %>% select(sector,colour)
  my_colours$sector <- gsub("   ","",my_colours$sector)
  my_colours <- left_join(data_countries %>% 
                            ungroup() %>% 
                            select(sector) %>% 
                            distinct() %>% 
                            arrange(sector),my_colours)
  
  p1 <- data_countries %>% ggplot(aes(x=year,y=value,fill=sector)) +
    geom_area(color="#636363") +
    theme_wl() +
    scale_fill_manual(values = my_colours$colour) +
    ylab("GHG Emissions (MtCO2e/year)") +
    theme(axis.title.x = element_blank(),
          panel.grid.major.x = element_blank(),
          panel.border = element_blank(),
          axis.line.x=element_line(colour='#636363'),
          axis.line.y=element_line(colour='#636363'),
          legend.position = "none",panel.background = element_blank())
  
  
  p2 <- labels %>%  ggplot(.,aes(y=position,label=sector)) +
    geom_point(aes(x=ifelse(sector %in% c("Energy","Industrial processes","AFOLU","Waste & Other"),1.9,2),fill=sector),
               shape=22,size=3,color='#636363') +
    geom_text(hjust=0,aes(x=2.1),color='#636363',vjust=0.5) +
    geom_vline(xintercept = 4,color='#636363') +
    theme_wl() +
    #scale_color_manual(values = c("white",'#636363','#636363','#636363','#636363','#636363','#636363','#636363','#636363','#636363','#636363')) +
    scale_fill_manual(values = c(labels$colour)) +
    scale_x_continuous(limits=c(1.9,4)) +
    theme(axis.title = element_blank(),
          panel.border = element_blank(),
          legend.position="none",
          axis.text.x = element_blank(),
          axis.text.y = element_blank(),
          axis.ticks = element_blank(),
          panel.grid.major = element_blank(),
          plot.background = element_blank(),
          plot.margin = unit(c(0,0,0,0),"cm"))
  
  ## indicators plot
  
  p3 <- data_indicators %>% 
    ungroup() %>% 
    filter(iso==country_iso) %>%
    add_row(var="empty",label="",value="") %>% 
    ggplot(.,aes(x=1,y=label,label=value)) +
    geom_text(size=10*(0.36),hjust=0,vjust=1,color='#636363')  +
    scale_y_discrete(labels = function(x) str_wrap(x, width = 20))+
    scale_x_continuous(limits=c(1,3)) +
    theme_wl()+
    theme(axis.title = element_blank(),
          axis.ticks = element_blank(),
          panel.background = element_blank(),
          panel.border = element_blank(),
          panel.grid = element_blank(),
          axis.text.x = element_blank(),
          axis.text.y = element_text(size=10),
          plot.caption = element_text(size=11,colour='#bdbdbd',hjust=1))
  
  if (country_iso=="EU27") { name = "European Union"}
  else {name <- countrycode(sourcevar = country_iso,origin="iso3c","country.name")}

  
  p <- p1 + p2 + wrap_elements(p3) + plot_layout(widths=c(4.4,2.4,3.8)) +
    plot_annotation(title=name,
                    #caption = 'Sources: EDGAR | GCB | Grassi et al.',
                    theme = theme_wl() + 
                      theme(plot.title=element_text(vjust=1,size=16),
                            plot.background = element_rect(fill = NA, colour = '#636363', size = 0.5),
                            plot.caption = element_text(size=11,colour='#bdbdbd',hjust=1)))
  
  
  return(p)
  
  
  
}

```

```{r plots, fig.width=10,fig.height=4}

countries <- data_indicators %>% filter(!is.na(population)) %>% filter(!is.na(co2_consumption)) %>% select(iso) %>% distinct()
countries <- countries %>%
  mutate(country=countrycode(iso,"iso3c","country.name")) %>% 
  mutate(country=ifelse(iso=="EU27","European Union",country))

for (i in 1:length(countries$iso)) {

  ggsave(plot_country(countries$iso[i],data_ghg,data_indicators),filename = paste0(countries$country[i],".png"),path = "results/countries/",device = "png",height = 4,width=10,dpi=300)
  ggsave(plot_country(countries$iso[i],data_ghg,data_indicators),filename = paste0(countries$country[i],".pdf"),path = "results/countries/",device = "pdf",height = 4,width=10)


}


```

```{r country_test, fig.width=10,fig.height=4}


```



```{r figure_top_emitters, fig.width=10,fig.height=12, fig.path="results/",dev=c('png','pdf','svg')}

top_emitters <- data_ghg %>% 
  filter(year==2022) %>% 
  group_by(iso) %>% 
  summarise(value=sum(value)) %>% 
  arrange(desc(value))


p1 <- plot_country_no_subheadings("CHN",data_ghg,data_indicators)
p2 <- plot_country_no_subheadings("USA",data_ghg,data_indicators)
p3 <- plot_country_no_subheadings("IND",data_ghg,data_indicators)
p4 <- plot_country_no_subheadings("EU27",data_ghg,data_indicators)
p5 <- plot_country_no_subheadings("RUS",data_ghg,data_indicators)
p6 <- plot_country_no_subheadings("BRA",data_ghg,data_indicators)

wrap_elements(p1) / wrap_elements(p2) / wrap_elements(p3)
wrap_elements(p4) / wrap_elements(p5) / wrap_elements(p6)

```

``` {r figure_global_sectors,fig.width=8,fig.height=4, fig.path="results/",dev=c('png','pdf','svg')}

## GHG emissions trend plot

data_world <- data_ghg %>% 
  filter(year>=1990) %>% 
  rename(sector=sector_tier_2) %>% 
  group_by(sector,year) %>%
  summarise(value=sum(value,na.rm=TRUE)/1e9)


## replace land use emissions
data_world <- data_world %>% 
  filter(sector!="LULUCF")
data_world <- rbind(data_world,data_gcb_co2_luc %>% 
                      filter(year>=1990) %>% 
                      filter(country=="Global") %>% 
                      select(year,value=mean) %>% 
                      mutate(sector="LULUCF") %>% 
                      mutate(year=as.numeric(year)) %>% 
                      mutate(sector=as.factor(sector)))


labels <- read.xlsx("sources/cc_sectors.xlsx",sheet=2)
labels <- labels %>% 
  arrange(desc(position)) %>% 
  mutate(position=1) %>% 
  mutate(position=cumsum(position))

labels$sector <- fct_reorder(labels$sector,labels$position)

my_colours <- labels %>% select(sector,colour)
my_colours$sector <- gsub("   ","",my_colours$sector)
my_colours <- left_join(data_world %>% 
                          ungroup() %>% 
                          select(sector) %>% 
                          distinct() %>% 
                          arrange(sector),my_colours)

p1 <- data_world %>% ggplot(aes(x=year,y=value,fill=sector)) +
  geom_area(color="#636363") +
  theme_wl() +
  scale_fill_manual(values = my_colours$colour) +
  ylab("GHG Emissions (MtCO2e/year)") +
  theme(axis.title.x = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.border = element_blank(),
        axis.line.x=element_line(colour='#636363'),
        axis.line.y=element_line(colour='#636363'),
        legend.position = "none",panel.background = element_blank())


p2 <- labels %>%  ggplot(.,aes(y=position,label=sector)) +
  geom_point(aes(x=ifelse(sector %in% c("Energy","Industrial processes","AFOLU","Waste & Other"),1.9,2),fill=sector),
             shape=22,size=3,color='#636363') +
  geom_text(hjust=0,aes(x=2.1),color='#636363',vjust=0.5) +
  theme_wl() +
  #scale_color_manual(values = c("white",'#636363','#636363','#636363','#636363','#636363','#636363','#636363','#636363','#636363','#636363')) +
  scale_fill_manual(values = c(labels$colour)) +
  scale_x_continuous(limits=c(1.9,4)) +
  theme(axis.title = element_blank(),
        panel.border = element_blank(),
        legend.position="none",
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        panel.grid.major = element_blank(),
        plot.background = element_blank(),
        plot.margin = unit(c(0,0,0,0),"cm"))

p1 + p2 + plot_layout(widths=c(4,2))

```

``` {r save}

metadata <- labelled::generate_dictionary(data_indicators) %>% 
  select(variable,units=label)



```
