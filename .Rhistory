# data_cc <- left_join(data_gcb_co2_cc,data_table_totals %>% select(year,gas,value_co2_foss=value),by=c("year","gas"))
# data_cc <- data_cc %>%
#   mutate(value=value/1e9) %>%
#   mutate(value=value_co2_foss-value) %>%
#   filter(year>=1990) %>%
#   mutate(gas="CO2 Fossil (excl. cement carbonation)") %>%
#   select(year,gas,value)
#
#
# data_table_totals <- rbind(data_table_totals,data_cc)
# Arrange factor levels
data_table_totals$gas <- as.factor(data_table_totals$gas)
data_table_totals$gas <- fct_relevel(data_table_totals$gas,"GHG","CO2 Fossil","CO2 LULUCF (Bookkeeping)","CH4","N2O","F-gases","CO2 LULUCF (Inventory)","CO2 Fossil (excl. cement carbonation)")
# Spread data and calculate relative and absolute changes in the latest year
data_table_totals <- spread(data_table_totals,year,value)
data_table_totals <- data_table_totals %>%
mutate(change_2022_2023_abs=`2023`-`2022`) %>%
mutate(change_2022_2023_rel=change_2022_2023_abs/`2022`)
# Add a blank row to separate values not in the total (inventory LULUCF and CO2 excl. carbonation)
data_table_totals <- rbind(data_table_totals %>%
ungroup() %>%
filter(!gas %in% c("CO2 LULUCF (Inventory)","CO2 Fossil (excl. cement carbonation)")) %>%
add_row(),
data_table_totals %>% filter(gas %in% c("CO2 LULUCF (Inventory)","CO2 Fossil (excl. cement carbonation)")))
# Write to excel file
pct = createStyle(numFmt="0.0%")
addWorksheet(wb,"total_by_gas")
writeData(wb, sheet = "total_by_gas", data_table_totals, colNames = T, rowNames = F)
addStyle(wb, "total_by_gas",style=pct,
cols=length(data_table_totals),
rows=1:length(data_table_totals$gas)+1,
gridExpand=TRUE)
# Calculate total emissions by sector
data_table_sectors <- data_ghg %>%
filter(year>=1990) %>%
group_by(sector_lv1,sector_lv2,sector_lv3,year) %>%
summarise(value=sum(value,na.rm=TRUE)/1e9)
# Spread and calculate relative and absolute emission changes in the latest year
data_table_sectors <- spread(data_table_sectors,year,value)
data_table_sectors <- data_table_sectors %>%
mutate(change_2022_2023_abs=`2023`-`2022`) %>%
mutate(change_2022_2023_rel=change_2022_2023_abs/`2022`)
# Write to excel file
addWorksheet(wb,"total_by_sector")
writeData(wb, sheet = "total_by_sector", data_table_sectors, colNames = T, rowNames = F)
addStyle(wb, "total_by_sector",style=pct,
cols=length(data_table_sectors),
rows=2:length(data_table_sectors$sector_lv1)+1,
gridExpand=TRUE)
# Calculate emissions by sector (first level) in 2023
plot_sector_shares_1 <- data_ghg %>%
filter(year==2023) %>%
group_by(sector_lv2,sector_lv2_colours,sector_lv2_icons) %>%
summarise(value=sum(value,na.rm=TRUE)/1e9) %>%
ungroup()
# Calculate the share of total for each sector at the first level
plot_sector_shares_1 <- plot_sector_shares_1 %>%
mutate(total=sum(plot_sector_shares_1$value)) %>%
mutate(share=value/total) %>%
mutate(share=round(share*100))
# Calculate the position of each label
plot_sector_shares_1 <- plot_sector_shares_1 %>%
arrange(desc(sector_lv2)) %>%
mutate(label_position=value) %>%
mutate(label_position=cumsum(label_position)) %>%
mutate(label_position=label_position-(value/2)) %>%
mutate(label=paste0(sector_lv2,"\n (",share,"%)"))
# Plot figure at the first level
p2 <- plot_sector_shares_1 %>%
ggplot(.,aes(x=1.6,y=value,fill=sector_lv2)) +
geom_col(color="#636363",width=0.5) +
geom_text(aes(x=1.3,y=label_position,label=label),size=3.5,hjust=1) +
geom_image(aes(x=1.6,y=label_position,image=sector_lv2_icons),by = "height",size=0.03) +
geom_text(data=plot_sector_shares_1 %>% filter(sector_lv2=="Energy: Power"),
aes(x=1.6,y=59.5,label=paste0(signif(total,3)," GtCO2e in 2023"))) +
xlim(0,3) +
ylim(0,60) +
scale_fill_manual(values = rev(plot_sector_shares_1$sector_lv2_colours)) +
theme_wl() +
theme(legend.position="none",
axis.title = element_blank(),
axis.text.x = element_blank(),
axis.text.y = element_blank(),
axis.ticks = element_blank(),
panel.grid.major = element_blank(),
panel.border = element_blank(),
plot.background = element_blank(),
plot.margin = unit(c(0,0,0,0),"cm"))
# Calculate emissions by sector (second level) in 2023
plot_sector_shares_2 <- data_ghg %>%
filter(year==2023) %>%
group_by(sector_lv2,sector_lv2_colours,sector_lv3) %>%
summarise(value=sum(value,na.rm=TRUE)/1e9) %>%
ungroup() %>%
mutate()
# Calculate the share of total for each sector at the second level
plot_sector_shares_2 <- plot_sector_shares_2 %>%
mutate(total=sum(plot_sector_shares_2$value)) %>%
mutate(share=value/total) %>%
mutate(share=round(share*100))
# Calculate the position of each label
plot_sector_shares_2 <- plot_sector_shares_2 %>%
arrange(desc(sector_lv3)) %>%
mutate(label_position=value) %>%
mutate(label_position=cumsum(label_position)) %>%
mutate(label_position=label_position-(value/2)) %>%
mutate(label=paste0(sector_lv3," (",share,"%)"))
# Plot figure at the second level
p3 <- plot_sector_shares_2 %>%
ggplot(.,aes(x=1,y=value,fill=sector_lv2)) +
geom_col(color="#636363") +
geom_text_repel(data=plot_sector_shares_2 %>% filter(!sector_lv2 %in% c("Energy: Power","Energy: Industry","Energy: Buildings")),
aes(x=1.6,y=label_position,label=label),
nudge_x      = 0.25,
direction    = "y",
hjust        = 0,
segment.size = 0.2,
point.size = NA,
size=3.5,
ylim = c(-3,60)
) +
xlim(0,8) +
ylim(0,60) +
scale_fill_manual(values = rev(plot_sector_shares_1$sector_lv2_colours)) +
theme_wl() +
theme(legend.position="none",
axis.title = element_blank(),
axis.text.x = element_blank(),
axis.text.y = element_blank(),
axis.ticks = element_blank(),
panel.border = element_blank(),
panel.grid.major = element_blank(),
plot.background = element_blank(),
plot.margin = unit(c(0,0,0,0),"cm"))
# Join figure
p2 + plot_spacer() + p3  + plot_layout(widths=c(2.2,-1.2,4)) + plot_annotation(title="Total greenhouse gas emissions by sector in 2023",
subtitle=bquote("Gt" ~CO[2]~ "/year"),
theme=theme(plot.title=element_text(hjust=0.25),
plot.subtitle = element_text(hjust=0.25)))
# Save figure data for designers
# data_table_sector_share <- rbind(plot_sector_shares_1 %>%
#                  arrange(sector_lv2) %>%
#                  mutate(column=1) %>%
#                  select(column,sector=sector_lv2,value,share,label),
#                plot_sector_shares_2 %>%
#                  arrange(sector_lv3) %>%
#                  mutate(column=2) %>%
#                  select(column,sector=sector_lv3,value,share,label))
# data_table_sector_share <- data_table_sector_share %>%
#   select(column,label,value,share)
#
#
# addWorksheet(wb,"shares_by_sector")
# writeData(wb, sheet = "shares_by_sector", data_table_sector_share, colNames = T, rowNames = F)
data_changes <- data_ghg %>%
filter(year %in% c(2022,2023)) %>%
group_by(year,sector_lv2,sector_lv2_colours) %>%
summarise(value=sum(value,na.rm=T)/1e9)
data_changes <- spread(data_changes,year,value)
data_changes <- data_changes %>%
mutate(change_abs=`2023`-`2022`,
change_rel=change_abs/`2022`)
###
data_changes <- data_ghg %>%
filter(year >= 1990 ) %>%
group_by(year,sector_lv2,sector_lv2_colours) %>%
summarise(value=sum(value,na.rm=T)/1e9) %>%
mutate(change_abs=NA)
sectors <- unique(data_changes$sector_lv2)
for (j in 1:length(sectors)) {
for (i in 1991:2023) {
data_changes$change_abs[data_changes$year==i & data_changes$sector_lv2==sectors[j]] <-
data_changes$value[data_changes$year==i & data_changes$sector_lv2==sectors[j]] -
data_changes$value[data_changes$year==i-1 & data_changes$sector_lv2==sectors[j]]
}
}
sector_colours <- data_changes %>% select(sector_lv2,sector_lv2_colours) %>% distinct()
data_changes %>%
filter(year>=2015) %>%
mutate(year=as.factor(year)) %>%
ggplot(.,aes(x=year,y=change_abs,fill=sector_lv2)) +
geom_col(color="#636363") +
geom_hline(yintercept=0) +
geom_point(data=data_changes %>% filter(year>=2015) %>% mutate(year=as.factor(year)) %>%  group_by(year) %>% summarise(change_abs=sum(change_abs)),
inherit.aes=FALSE,aes(x=year,y=change_abs)) +
scale_fill_manual(values=sector_colours$sector_lv2_colours) +
theme_wl() +
labs(title="Change in total emissions by year and sector",
subtitle="GtCO2e") +
theme(axis.title = element_blank(),
legend.title = element_blank())
plot_sankey <- data_ghg %>%
filter(year==2023) %>%
group_by(sector_lv2,gas) %>%
summarise(value=sum(value,na.rm=TRUE))
View(plot_sankey)
library(ggsankey)
plot_sankey <- data_ghg %>%
filter(year==2023) %>%
group_by(sector_lv2) %>%
summarise(value=sum(value,na.rm=TRUE))
plot_sankey <- left_join(plot_sankey,
data_ghg %>%
filter(year==2023) %>%
group_by(sector_lv2,gas) %>%
summarise(value=sum(value,na.rm=TRUE)))
plot_sankey <- data_ghg %>%
filter(year==2023) %>%
group_by(sector_lv2) %>%
summarise(value=sum(value,na.rm=TRUE))
plot_sankey <- left_join(plot_sankey,
data_ghg %>%
filter(year==2023) %>%
group_by(sector_lv2,gas) %>%
summarise(value=sum(value,na.rm=TRUE)))
plot_sankey <- data_ghg %>%
filter(year==2023) %>%
group_by(sector_lv2) %>%
summarise(value=sum(value,na.rm=TRUE))
plot_sankey <- left_join(plot_sankey,
data_ghg %>%
filter(year==2023) %>%
group_by(sector_lv2,gas) %>%
summarise(value=sum(value,na.rm=TRUE)),
by = join_by(sector_lv2))
#
#
# library(ggsankey)
#
# plot_sankey %>% ggplot(.,aes(x=))
plot_sankey %>% ggplot(.,aes(x=sector_lv2,next_x=gas,node=value.x,next_node=value.y,fill=factor(gas))) +
geom_sankey()
library(ggalluvial)
install.packages(ggalluvial)
install.packages('ggalluvial')
library(ggalluvial)
plot_sankey <- data_ghg %>%
filter(year==2023) %>%
group_by(sector_lv2,gas) %>%
summarise(value=sum(value,na.rm=TRUE))
ggplot(data = plot_sankey,
aes(axis1 = sector_lv2, axis2 = gas, y = value)) +
geom_alluvium(aes(fill = gas)) +
geom_stratum()
ggplot(data = plot_sankey,
aes(axis1 = sector_lv2, axis2 = gas, y = value)) +
geom_alluvium(aes(fill = gas)) +
geom_stratum() +
geom_text(stat = "stratum",
aes(label = after_stat(stratum))) +
theme_wl()
ggplot(data = plot_sankey,
aes(axis1 = sector_lv2, axis2 = gas, y = value)) +
geom_alluvium(aes(fill = gas)) +
geom_stratum() +
geom_text(stat = "stratum",
aes(label = after_stat(stratum))) +
scale_x_discrete(limits = c("sector_lv2", "gas"),
expand = c(0.15, 0.05)) +
theme_wl()
ggplot(data = plot_sankey,
aes(axis1 = sector_lv2, axis2 = gas, y = value)) +
geom_alluvium(aes(fill = gas)) +
geom_stratum() +
geom_text(stat = "stratum",
aes(label = after_stat(stratum))) +
scale_x_discrete(limits = c("sector_lv2", "gas"),
expand = c(0.15, 0.05)) +
theme_wl()
ggplot(data = plot_sankey,
aes(axis1 = sector_lv2, axis2 = gas, y = value)) +
geom_alluvium(aes(fill = gas)) +
geom_stratum() +
geom_text(stat = "stratum",
aes(label = after_stat(stratum))) +
scale_x_discrete(limits = c("sector_lv2", "gas"),
expand = c(0.15, 0.05)) +
theme_void()
ggplot(data = plot_sankey,
aes(axis1 = sector_lv2, axis2 = gas, y = value)) +
geom_alluvium(aes(fill = gas),color='#636363') +
geom_stratum() +
geom_text(stat = "stratum",
aes(label = after_stat(stratum))) +
scale_x_discrete(limits = c("sector_lv2", "gas"),
expand = c(0.15, 0.05)) +
theme_void()
plot_sankey <- data_ghg %>%
filter(year==2023) %>%
mutate(gas=ifelse(grepl("CO2",gas),"CO2",gas)) +
group_by(sector_lv2,gas) %>%
summarise(value=sum(value,na.rm=TRUE))
plot_sankey <- data_ghg %>%
filter(year==2023) %>%
mutate(gas=ifelse(grepl("CO2",gas),"CO2",gas)) +
group_by(sector_lv2,gas) %>%
summarise(value=sum(value,na.rm=TRUE))
plot_sankey <- data_ghg %>%
ungroup() %>%
filter(year==2023) %>%
mutate(gas=ifelse(grepl("CO2",gas),"CO2",gas)) +
group_by(sector_lv2,gas) %>%
summarise(value=sum(value,na.rm=TRUE))
plot_sankey <- data_ghg %>%
ungroup() %>%
filter(year==2023) %>%
mutate(gas=ifelse(grepl("CO2",gas),"CO2",gas)) #+
plot_sankey <- data_ghg %>%
mutate(gas=as.character(gas)) %>%
filter(year==2023) %>%
mutate(gas=ifelse(grepl("CO2",gas),"CO2",gas)) #+
plot_sankey <- data_ghg %>%
mutate(gas=as.character(gas)) %>%
filter(year==2023) %>%
mutate(gas=ifelse(grepl("CO2",gas),"CO2",gas)) +
group_by(sector_lv2,gas) %>%
summarise(value=sum(value,na.rm=TRUE))
plot_sankey <- data_ghg %>%
mutate(gas=as.character(gas)) %>%
filter(year==2023) %>%
mutate(gas=ifelse(grepl("CO2",gas),"CO2",gas))  %>%
group_by(sector_lv2,gas) %>%
summarise(value=sum(value,na.rm=TRUE))
plot_sankey <- data_ghg %>%
mutate(gas=as.character(gas)) %>%
filter(year==2023) %>%
mutate(gas=ifelse(grepl("CO2",gas),"CO2",gas))  %>%
group_by(sector_lv2,gas) %>%
summarise(value=sum(value,na.rm=TRUE))
library(ggalluvial)
ggplot(data = plot_sankey,
aes(axis1 = sector_lv2, axis2 = gas, y = value)) +
geom_alluvium(aes(fill = gas),color='#636363') +
geom_stratum() +
geom_text(stat = "stratum",
aes(label = after_stat(stratum))) +
scale_x_discrete(limits = c("sector_lv2", "gas"),
expand = c(0.15, 0.05)) +
theme_void()
plot_sankey$gas <- as.factor(plot_sankey$gas)
plot_sankey$gas <- as.factor(plot_sankey$gas)
plot_sankey$gas <- fct_relevel(plot_sankey$gas,"CO2","CH4","N2O","F-gases")
ggplot(data = plot_sankey,
aes(axis1 = sector_lv2, axis2 = gas, y = value)) +
geom_alluvium(aes(fill = gas),color='#636363') +
geom_stratum() +
geom_text(stat = "stratum",
aes(label = after_stat(stratum))) +
scale_x_discrete(limits = c("sector_lv2", "gas"),
expand = c(0.15, 0.05)) +
theme_void()
ggplot(data = plot_sankey,
aes(axis1 = sector_lv2, axis2 = gas, y = value)) +
geom_alluvium(aes(fill = gas),color='#636363') +
geom_stratum() +
geom_text(stat = "stratum",
aes(label = after_stat(stratum))) +
scale_x_discrete(limits = c("sector_lv2", "gas"),
expand = c(0.15, 0.05)) +
theme_void() +
theme(legend.position = "none")
ggplot(data = plot_sankey,
aes(axis1 = sector_lv2, axis2 = gas, y = value)) +
geom_alluvium(aes(fill = gas),color='#636363') +
geom_stratum() +
geom_text(stat = "stratum",
aes(label = after_stat(stratum))) +
scale_x_discrete(limits = c("sector_lv2", "gas"),
expand = c(0.15, 0.05)) +
theme_void() +
theme(legend.position = "none")
ggplot(data = plot_sankey,
aes(axis1 = sector_lv2, axis2 = gas, y = value)) +
geom_alluvium(aes(fill = gas),color='#636363') +
geom_stratum() +
geom_text(stat = "stratum",
aes(label = after_stat(stratum))) +
scale_x_discrete(limits = c("sector_lv2", "gas"),
expand = c(0.15, 0.05)) +
theme_void() +
theme(legend.position = "none")
ggplot(data = plot_sankey,
aes(axis1 = sector_lv2, axis2 = gas, y = value)) +
geom_alluvium(aes(fill = gas),color='#636363') +
geom_stratum() +
geom_text(stat = "stratum",
aes(label = after_stat(stratum))) +
scale_x_discrete(limits = c("sector_lv2", "gas"),
expand = c(0.15, 0.05)) +
theme_void() +
theme(legend.position = "none")
ggplot(data = plot_sankey,
aes(axis1 = sector_lv2, axis2 = gas, y = value)) +
geom_alluvium(aes(fill = gas),color='#636363') +
geom_stratum() +
geom_text(stat = "stratum",
aes(label = after_stat(stratum)),hjust=0) +
scale_x_discrete(limits = c("sector_lv2", "gas"),
expand = c(0.15, 0.05)) +
theme_void() +
theme(legend.position = "none")
ggplot(data = plot_sankey,
aes(axis1 = sector_lv2, axis2 = gas, y = value)) +
geom_alluvium(aes(fill = gas),color='#636363') +
geom_stratum() +
geom_text(stat = "stratum",
aes(label = after_stat(stratum)),hjust=-1) +
scale_x_discrete(limits = c("sector_lv2", "gas"),
expand = c(0.15, 0.05)) +
theme_void() +
theme(legend.position = "none")
ggplot(data = plot_sankey,
aes(axis1 = sector_lv2, axis2 = gas, y = value)) +
geom_alluvium(aes(fill = gas),color='#636363') +
geom_stratum() +
geom_text(stat = "stratum",
aes(label = after_stat(stratum)),hjust=0) +
scale_x_discrete(limits = c("sector_lv2", "gas"),
expand = c(0.15, 0.05)) +
theme_void() +
theme(legend.position = "none")
ggplot(data = plot_sankey,
aes(axis1 = sector_lv2, axis2 = gas, y = value)) +
geom_alluvium(aes(fill = gas),color='#636363') +
geom_stratum() +
geom_text(stat = "stratum",
aes(label = after_stat(stratum))) +
scale_x_discrete(limits = c("sector_lv2", "gas"),
expand = c(0.15, 0.05)) +
theme_void() +
theme(legend.position = "none")
ggplot(data = plot_sankey,
aes(axis1 = sector_lv2, axis2 = gas, y = value)) +
geom_alluvium(aes(fill = gas),color='#636363') +
geom_stratum(aes(fill=gas)) +
geom_text(stat = "stratum",
aes(label = after_stat(stratum))) +
scale_x_discrete(limits = c("sector_lv2", "gas"),
expand = c(0.15, 0.05)) +
theme_void() +
theme(legend.position = "none")
ggplot(data = plot_sankey,
aes(axis1 = sector_lv2, axis2 = gas, y = value,fill=gas)) +
geom_alluvium(aes(fill = gas),color='#636363') +
geom_stratum(aes(fill=gas)) +
geom_text(stat = "stratum",
aes(label = after_stat(stratum))) +
scale_x_discrete(limits = c("sector_lv2", "gas"),
expand = c(0.15, 0.05)) +
theme_void() +
theme(legend.position = "none")
ggplot(data = plot_sankey,
aes(axis1 = sector_lv2, axis2 = gas, y = value,fill=gas)) +
geom_alluvium(aes(fill = gas),color='#636363') +
geom_stratum() +
geom_text(stat = "stratum",
aes(label = after_stat(stratum))) +
scale_x_discrete(limits = c("sector_lv2", "gas"),
expand = c(0.15, 0.05)) +
theme_void() +
theme(legend.position = "none")
ggplot(data = plot_sankey,
aes(axis1 = sector_lv2, axis2 = gas, y = value)) +
geom_alluvium(aes(fill = gas),color='#636363') +
geom_stratum(aes(fill=gas)) +
geom_text(stat = "stratum",
aes(label = after_stat(stratum))) +
scale_x_discrete(limits = c("sector_lv2", "gas"),
expand = c(0.15, 0.05)) +
scale_fill_manual(values = colors) +
theme_void() +
theme(legend.position = "none")
ggplot(data = plot_sankey,
aes(axis1 = sector_lv2, axis2 = gas, y = value)) +
geom_alluvium(aes(fill = gas),color='#636363') +
geom_stratum(aes(fill=gas)) +
geom_text(stat = "stratum",
aes(label = after_stat(stratum))) +
scale_x_discrete(limits = c("sector_lv2", "gas"),
expand = c(0.15, 0.05)) +
scale_fill_brewer(palette = "Set2") +
theme_void() +
theme(legend.position = "none")
ggplot(data = plot_sankey,
aes(axis1 = sector_lv2, axis2 = gas, y = value)) +
geom_alluvium(aes(fill = gas),color='#636363') +
geom_stratum(aes(fill=gas)) +
geom_text(stat = "stratum",
aes(label = after_stat(stratum))) +
scale_x_discrete(limits = c("sector_lv2", "gas"),
expand = c(0.15, 0.05)) +
scale_fill_brewer(palette = "Set2",na.value="#939393") +
theme_void() +
theme(legend.position = "none")
library(networkD3)
??networkD3
?networkD3
?sankeyNetwork
sankeyNetwork(Links=plot_sankey$gas,Nodes=plot_sankey$sector_lv2,Value=plot_sankey$value)
sankeyNetwork(Links=plot_sankey$gas,Nodes=plot_sankey$sector_lv2,Value=plot_sankey$value,Source = "sector_lv2")
ggplot(data = plot_sankey,
aes(axis1 = sector_lv2, axis2 = gas, y = value)) +
geom_alluvium(aes(fill = gas),color='#636363') +
geom_stratum(aes(fill=gas)) +
geom_text(stat = "stratum",
aes(label = after_stat(stratum))) +
scale_x_discrete(limits = c("sector_lv2", "gas"),
expand = c(0.15, 0.05)) +
scale_fill_brewer(palette = "Set2",na.value="#939393") +
theme_void() +
theme(legend.position = "none")
View(gwps)
