---
title: "UNEP-Gap-Report-2024-Sectors"
author: "William F. Lamb"
date: "17 4 2024"
output: word_document
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = FALSE)

rm(list = ls())

library(tidyverse)
library(openxlsx)
library(countrycode)
library(ggrepel)
library(patchwork)
library(zoo)
library(RColorBrewer)

```

```{r functions}

## figure style

theme_wl <- function() {
  
  font <- "sans"
  
  theme_bw() %+replace%
    
    theme(
      
      # Grid elements
      
      panel.grid.minor = element_blank(),    #strip minor gridlines
      axis.ticks = element_line(color="#636363",size = 0.7),          #strip axis ticks
      
      
      # Border lines
      panel.border = element_rect(color="#636363",fill=NA,size = 0.7),
      panel.background = element_blank(),
      
      # Text elements
      
      plot.title = element_text(             #title
        family = font,            #set font family
        size = 14,                #set font size
        face = 'bold',            #bold typeface
        hjust = 0,                #left align
        vjust = 3,                #raise slightly
        color = '#636363'),       #color
      
      plot.subtitle = element_text(
        family = font,
        size = 12,
        hjust = 0,
        vjust = 2,
        color = '#636363'),
      
      plot.caption = element_text(           #caption
        family = font,            #font family
        size = 9,                 #font size
        hjust = 0,                #right align
        color = '#bdbdbd'),       #color
      
      axis.title = element_text(             #axis titles
        family = font,            #font family
        size = 10,                #font size
        color = '#636363'),       #color
      
      axis.text = element_text(              #axis text
        family = font,            #axis famuly
        size = 9,                 #font size
        color = '#636363'),       #color
      
      axis.text.x = element_text(            #margin for axis text
        margin=margin(5, b = 10)),
      
      text = element_text(
        family = font,
        color = '#636363')
      
    )
  
}

```

```{r load_ember_data}

wd_ember <- read.csv("Sources/EMBER_electricity_yearly_full_release_long_format.csv")

wd_ember <- wd_ember %>% 
  filter(Category=="Electricity generation") %>% 
  filter(Unit=="TWh")

wd_ember <- wd_ember %>%
  mutate(category=ifelse(Variable=="Wind and Solar","Wind and Solar",NA)) %>%
  mutate(category=ifelse(Variable=="Coal","Fossil",category)) %>%
  mutate(category=ifelse(Variable=="Gas","Fossil",category)) %>%
  mutate(category=ifelse(Variable=="Nuclear","Nuclear",category)) %>%
  mutate(category=ifelse(Variable=="Bioenergy","Other renewable",category)) %>%
  mutate(category=ifelse(Variable=="Hydro","Other renewable",category)) %>%
  mutate(category=ifelse(Variable=="Other Renewables","Other renewable",category)) %>%
  mutate(category=ifelse(Variable=="Other Fossil","Fossil",category)) %>%
  mutate(category=ifelse(Variable=="Total Generation","Total",category)) %>%
  filter(!is.na(category))

# wd_ember <- wd_ember %>% 
#   mutate(category=ifelse(Variable=="Wind and Solar","Renewable (Wind & Solar)",NA)) %>% 
#   mutate(category=ifelse(Variable=="Coal","Fossil (coal)",category)) %>% 
#   mutate(category=ifelse(Variable=="Gas","Fossil (gas)",category)) %>% 
#   mutate(category=ifelse(Variable=="Nuclear","Nuclear",category)) %>% 
#   mutate(category=ifelse(Variable=="Bioenergy","Renewable (other)",category)) %>% 
#   mutate(category=ifelse(Variable=="Hydro","Renewable (other)",category)) %>% 
#   mutate(category=ifelse(Variable=="Other Renewables","Renewable (other)",category)) %>% 
#   mutate(category=ifelse(Variable=="Other Fossil","Fossil (other)",category)) %>% 
#   mutate(category=ifelse(Variable=="Total Generation","Total",category)) %>% 
#   filter(!is.na(category))

wd_ember <- rbind(wd_ember %>% filter(Area.type=="Country"),
                  wd_ember %>% filter(Area=="World"))

wd_ember <- wd_ember %>% 
  select(country=Area,iso=Country.code,year=Year,EU,G20,category,value=Value) %>% 
  mutate(year=as.numeric(year)) %>% 
  mutate(value=as.numeric(value)) %>% 
  mutate(sector="Power") %>% 
  mutate(units="TWh")

wd_ember <- wd_ember %>% 
  group_by(country,sector,category,units,year) %>% 
  summarise(value=sum(value,na.rm=TRUE))

``` 

```{r load_iea_data}


iea_industry <- read.xlsx("sources/not public/iea_web_2021.xlsx",sheet=1)
iea_transport <- read.xlsx("sources/not public/iea_web_2021.xlsx",sheet=2)
iea_residential <- read.xlsx("sources/not public/iea_web_2021.xlsx",sheet=3)
iea_commercial <- read.xlsx("sources/not public/iea_web_2021.xlsx",sheet=4)

wd_iea <- rbind(iea_industry %>% mutate(sector="Industry"),
                iea_transport %>% mutate(sector="Transport"))
wd_iea <- rbind(wd_iea,iea_residential %>% mutate(sector="Buildings"))
wd_iea <- rbind(wd_iea,iea_commercial %>% mutate(sector="Buildings"))

wd_iea <- gather(wd_iea,year,value,`1960`:`2019`)
wd_iea <- wd_iea %>% 
  rename(country=COUNTRY,product=PRODUCT) %>% 
  mutate(value=as.numeric(value)) %>% 
  mutate(year=as.numeric(year)) %>% 
  filter(year>=1990)
  
wd_iea <- wd_iea %>% 
  group_by(country,sector,product,year) %>%
  summarise(value=sum(value,na.rm=T)) %>% 
  arrange(country,sector,product)
  
write.xlsx(wd_iea %>% 
  filter(country=="World") %>% 
  filter(year==2019),"cc_iea_product_split.xlsx")

cc_products <- read.xlsx("Sources/cc_iea_product_split.xlsx")

wd_iea <- left_join(wd_iea,cc_products %>% select(sector,product,category))

wd_iea <- wd_iea %>% 
  filter(!is.na(category)) %>%
  mutate(units="EJ") %>% 
  group_by(country,sector,category,units,year) %>% 
  summarise(value=sum(value)/1e6)


blarg <- wd_iea %>% 
  filter(country=="World") %>% 
  filter(year==2019)

```
  
```{r regionalisation}

wd_data <- rbind(wd_iea,wd_ember)


########## country harmonisation

wd_data_isos <- wd_data %>% 
  filter(!grepl("OECD",country)) %>% 
  filter(!grepl("Memo",country)) %>% 
  filter(!grepl("Africa",country)) %>% 
  filter(!grepl("Soviet Union",country)) %>% 
  ungroup() %>% 
  select(country) %>% 
  distinct() %>% 
  mutate(iso=countrycode(country,"country.name","iso3c"))

wd_data <- left_join(wd_data,wd_data_isos,by = join_by(country))
wd_data <- wd_data %>% mutate(iso=ifelse(country=="World","WLD",iso))

wd_data_isos <- wd_data %>% 
  ungroup() %>% 
  select(iso) %>% 
  distinct() %>% 
  mutate(name=countrycode(iso,"iso3c","country.name")) %>% 
  mutate(name=ifelse(iso=="WLD","World",name))

wd_data <- left_join(wd_data,wd_data_isos)
wd_data <- wd_data %>% 
  mutate(country=name) %>% 
  select(-name)

########### merge EU

cc_EU <- read.csv("https://raw.githubusercontent.com/openclimatedata/countrygroups/main/data/european-union.csv") %>% 
  select(iso=Code) %>% 
  mutate(EU="EU27")

wd_data <- left_join(wd_data,cc_EU,by="iso")
wd_data <- wd_data %>% 
  mutate(iso=ifelse(!is.na(EU),EU,iso)) %>% 
  mutate(country=ifelse(!is.na(EU),EU,country))

wd_data <- wd_data %>% 
  group_by(country,iso,sector,category,units,year) %>% 
  summarise(value=sum(value,na.rm=T))

########### get G20

cc_G20 <- read.csv("https://raw.githubusercontent.com/openclimatedata/countrygroups/main/data/g20.csv") %>% 
  select(iso=Code) %>% 
  mutate(G20="G20")

wd_data <- left_join(wd_data,cc_G20,by="iso")
wd_data <- wd_data %>% 
  mutate(G20=ifelse(iso=="EU27","G20",G20))

########### choose countries

wd_data <- wd_data %>% 
  mutate(regions=ifelse(iso %in% c("USA","CHN","IND","EU27"),country,NA)) %>% 
  mutate(regions=ifelse(country=="World",country,regions))

wd_data_g20 <- wd_data %>% 
  filter(G20=="G20") %>% 
  filter(is.na(regions)) %>% 
  mutate(iso="G20 (other)") %>% 
  mutate(country="G20 (other)") %>% 
  mutate(regions="G20 (other)") %>% 
  group_by(iso,country,regions,sector,category,units,year) %>% 
  summarise(value=sum(value,na.rm=T))

wd_data <- wd_data %>% 
  filter(!is.na(regions))
wd_data <- rbind(wd_data,wd_data_g20)

wd_data <- wd_data %>% 
  select(country,iso,sector,category,units,year,value)

blarg <- wd_data %>% filter(country=="World") %>% filter(year==2019)


```

``` {r power_sector_shares}

wd_power <- wd_data %>% 
  filter(category!="Total") %>% 
  filter(sector=="Power") %>% 
  #filter(year==2022) %>%  
  group_by(country,iso,sector,year) %>% 
  mutate(sector_total=sum(value)) %>% 
  mutate(ratio=value/sector_total)

```

``` {r plot_sectors_fossil,fig.height=9,fig.width=10,fig.path="results/",dev=c('png','pdf','svg')}

wd_data$country <- as.factor(wd_data$country)
wd_data$country <- fct_relevel(wd_data$country,"G20 (other)","India","EU27","United States","China","World")

wd_data$sector <- as.factor(wd_data$sector)
wd_data$sector <- fct_relevel(wd_data$sector,"Power","Industry","Buildings","Transport")

wd_data <- wd_data %>% 
  arrange(year,country,iso,sector,category)

wd_data_ratios <- wd_data %>% 
  filter(category!="Total") %>% 
  group_by(country,iso,sector,year) %>% 
  mutate(sector_total=sum(value)) %>% 
  mutate(ratio=value/sector_total) %>% 
  filter(year==2019)

wd_data_changes <- wd_data %>% 
  filter(year %in% c(2010,2019)) %>% 
  group_by(country,iso,sector,category) %>%
  mutate(change_abs=last(value)-first(value))

wd_data_changes <- left_join(wd_data_changes %>% filter(category!="Total"),
                            wd_data_changes %>% 
                              ungroup() %>% 
                              filter(category=="Total") %>% 
                              select(-category,-value) %>% 
                              rename(change_abs_total=change_abs))

# wd_data_changes <- wd_data_changes %>% 
#   mutate(change_ratio=change_abs/change_abs_total) %>% 
#   filter(year==2019)

wd_data_plot <- left_join(wd_data_ratios,wd_data_changes)


wd_data_plot <- wd_data_plot %>% 
  rename(value_2019=value)

wd_data_plot <- gather(wd_data_plot,var,value,-country,-iso,-sector,-category,-units,-year)
wd_data_plot <- wd_data_plot %>% 
  mutate(var=ifelse(var=="ratio","Contribution by source in 2019 (%)",var)) %>% 
  mutate(var=ifelse(var=="change_abs","Change by source from 2010-2019",var))

wd_data_plot$var <- as.factor(wd_data_plot$var)
wd_data_plot$var <- fct_relevel(wd_data_plot$var,"Contribution by source in 2019 (%)","Change by source from 2010-2019")


# wd_data_plot$category <- as.factor(wd_data_plot$category)
# wd_data_plot$category <- fct_relevel(wd_data_plot$category,"Fossil","Fossil (direct)","Power sector","Nuclear","Biofuels (direct)","Other renewable","Renewables (direct)","Wind and Solar")

wd_data_plot$category <- as.factor(wd_data_plot$category)
wd_data_plot$category <- fct_relevel(wd_data_plot$category,"Fossil (coal)","Fossil (gas)","Fossil (oil)","Fossil (other)","Power sector","Nuclear","Biofuels","Renewable (other)","Renewable (Wind & Solar)","Renewables")

blarg <- wd_data_plot %>% filter(iso=="WLD")

p1 <- wd_data_plot %>% 
  filter(sector=="Power") %>% 
  filter(var %in% c("Contribution by source in 2019 (%)","Change by source from 2010-2019")) %>% 
  ggplot(.,aes(x=value,y=country,fill=category)) +
  geom_col(color="#636363",position = position_stack(reverse = TRUE)) +
  geom_blank(data=wd_data_plot %>% 
               filter(sector=="Power") %>% 
               filter(iso=="WLD") %>% 
               filter(var=="Change by source from 2010-2019") %>% 
               filter(value>0) %>% 
               group_by(sector,iso,var) %>% 
               summarise(value=sum(value)),
             inherit.aes=FALSE,aes(x = -value)) +
  geom_vline(data=wd_data_plot %>% filter(var=="Change by source from 2010-2019"),aes(xintercept = 0),color="#525252",linewidth=0.75) +
  facet_grid(.~var,scales="free") +
  theme_wl() +
  theme(axis.title=element_blank(),
        legend.title=element_blank()) +
  labs(title="Power sector",
       subtitle="Electricity generation (Twh)") +
  #scale_fill_manual(values=c("#bf812d","#f0f0f0","#c7eae5","#35978f"))
  scale_fill_manual(values=c("#8c510a","#bf812d","#f6e8c3","#f0f0f0","#c7eae5","#35978f"))

p2 <- wd_data_plot %>% 
  filter(sector=="Industry") %>% 
  filter(var %in% c("Contribution by source in 2019 (%)","Change by source from 2010-2019")) %>% 
  ggplot(.,aes(x=value,y=country,fill=category)) +
  geom_col(color="#636363",position = position_stack(reverse = TRUE)) +
  geom_blank(data=wd_data_plot %>% 
               filter(sector=="Industry") %>% 
               filter(iso=="WLD") %>% 
               filter(var=="Change by source from 2010-2019") %>% 
               filter(value>0) %>% 
               group_by(sector,iso,var) %>% 
               summarise(value=sum(value)),
             inherit.aes=FALSE,aes(x = -value)) +
  geom_vline(data=wd_data_plot %>% filter(var=="Change by source from 2010-2019"),aes(xintercept = 0),color="#525252",linewidth=0.75) +
  facet_grid(.~var,scales="free") +
  theme_wl() +
  theme(axis.title=element_blank(),
        legend.title=element_blank()) +
  labs(title="Industry sector",
       subtitle="Final energy consumption (EJ)") +
  #scale_fill_manual(values=c("#bf812d","#f0f0f0","#c7eae5","#35978f"))
  scale_fill_manual(values=c("#8c510a","#bf812d","#f6e8c3","#f0f0f0","#c7eae5","#35978f"))

p3 <- wd_data_plot %>% 
  filter(sector=="Buildings") %>% 
  filter(var %in% c("Contribution by source in 2019 (%)","Change by source from 2010-2019")) %>% 
  ggplot(.,aes(x=value,y=country,fill=category)) +
  geom_col(color="#636363",position = position_stack(reverse = TRUE)) +
  geom_blank(data=wd_data_plot %>% 
               filter(sector=="Buildings") %>% 
               filter(iso=="WLD") %>% 
               filter(var=="Change by source from 2010-2019") %>% 
               filter(value>0) %>% 
               group_by(sector,iso,var) %>% 
               summarise(value=sum(value)),
             inherit.aes=FALSE,aes(x = -value)) +
  geom_vline(data=wd_data_plot %>% filter(var=="Change by source from 2010-2019"),aes(xintercept = 0),color="#525252",linewidth=0.75) +
  facet_grid(.~var,scales="free") +
  theme_wl() +
  theme(axis.title=element_blank(),
        legend.title=element_blank()) +
  labs(title="Buildings sector",
       subtitle="Final energy consumption (EJ)") +
  #scale_fill_manual(values=c("#bf812d","#f0f0f0","#c7eae5","#35978f"))
  scale_fill_manual(values=c("#bf812d","#dfc27d","#f6e8c3","#f0f0f0","#c7eae5","#35978f"))

p4 <- wd_data_plot %>% 
  filter(sector=="Transport") %>% 
  filter(var %in% c("Contribution by source in 2019 (%)","Change by source from 2010-2019")) %>% 
  ggplot(.,aes(x=value,y=country,fill=category)) +
  geom_col(color="#636363",position = position_stack(reverse = TRUE)) +
  geom_blank(data=wd_data_plot %>% 
               filter(sector=="Transport") %>% 
               filter(iso=="WLD") %>% 
               filter(var=="Change by source from 2010-2019") %>% 
               filter(value>0) %>% 
               group_by(sector,iso,var) %>% 
               summarise(value=sum(value)),
             inherit.aes=FALSE,aes(x = -value)) +
  geom_vline(data=wd_data_plot %>% filter(var=="Change by source from 2010-2019"),aes(xintercept = 0),color="#525252",linewidth=0.75) +
  facet_grid(.~var,scales="free") +
  theme_wl() +
  theme(axis.title=element_blank(),
        legend.title=element_blank()) +
  labs(title="Transport sector",
       subtitle="Final energy consumption (EJ)") +
  #scale_fill_manual(values=c("#bf812d","#f0f0f0","#c7eae5","#35978f"))
  scale_fill_manual(values=c("#dfc27d","#f6e8c3","#f0f0f0","#c7eae5","#35978f"))

p1 / p2 / p3 / p4


blarg <- wd_data_plot %>% 
               filter(sector=="Transport") %>% 
               filter(iso=="WLD") %>% 
               filter(var=="Change by source from 2010-2019")

```


