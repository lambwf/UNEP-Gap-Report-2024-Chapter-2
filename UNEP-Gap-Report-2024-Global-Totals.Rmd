---
title: "UNEP-Gap-Report-2024-Global-Totals"
author: "William F. Lamb"
output: word_document
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = FALSE)

rm(list = ls())

library(tidyverse)
library(openxlsx)
library(countrycode)
library(ggrepel)
library(patchwork)
library(zoo)
library(RColorBrewer)
library(WDI)
library(labelled)
library(grid)
library(ggimage)

source("https://raw.githubusercontent.com/lambwf/Codebase/main/figure_style.R")
source("https://raw.githubusercontent.com/lambwf/Codebase/main/reshape_with_labels.R")
source("https://raw.githubusercontent.com/lambwf/Codebase/main/locate_shares.R")
source("https://raw.githubusercontent.com/lambwf/Codebase/main/load_gcb_countries_v2023.R")
source("https://raw.githubusercontent.com/lambwf/Codebase/main/load_edgar_v8.R")



```

```{r load_EDGAR}

## load EDGAR data (https://edgar.jrc.ec.europa.eu/dataset_ghg80)

edgar_co2 <- read.xlsx("sources/IEA_EDGAR_CO2_1970_2022.xlsx",sheet=2,startRow=10)
edgar_ch4 <- read.xlsx("sources/EDGAR_CH4_1970_2022.xlsx",sheet=2,startRow = 10)
edgar_n2o <- read.xlsx("sources/EDGAR_N2O_1970_2022.xlsx",sheet=2,startRow = 10)
edgar_fgas <- read.xlsx("sources/EDGAR_F-gases_1990_2022.xlsx",sheet=2,startRow = 10)
data_ghg <- load_edgar(edgar_co2,edgar_ch4,edgar_n2o,edgar_fgas)


## join GWPs and calculate CO2e

gwps <- read.csv("https://raw.githubusercontent.com/openclimatedata/globalwarmingpotentials/main/globalwarmingpotentials.csv",skip = 9)

data_ghg$gas <- gsub("-","",data_ghg$gas)
data_ghg <- left_join(data_ghg,gwps %>% select(gas=Species,AR6GWP100)) %>% 
  mutate(AR6GWP100=ifelse(gas=="CO2",1,AR6GWP100))

# check all gwps joined
check <- data_ghg %>% filter(is.na(AR6GWP100))
check <- data_ghg %>% select(gas,AR6GWP100) %>% distinct()

data_ghg <- data_ghg %>% mutate(value_gwp=value*AR6GWP100)


list_fgases <- data_ghg %>% 
  select(gas) %>% 
  distinct() %>% 
  mutate(group=ifelse(gas=="CO2","CO2 Fossil",NA)) %>% 
  mutate(group=ifelse(gas=="CH4","CH4",group)) %>% 
  mutate(group=ifelse(gas=="N2O","N2O",group)) %>% 
  mutate(group=ifelse(is.na(group),"Fgases",group))

data_ghg <- left_join(data_ghg,list_fgases,by="gas")
data_ghg <- data_ghg %>% 
  mutate(gas=group) %>% 
  group_by(iso,country,code,code_description,gas,year) %>% 
  summarise(value=sum(value_gwp,na.rm=TRUE))

## Gg to tons
data_ghg$value = data_ghg$value*1000

# check global totals
check <- data_ghg %>% filter(year==2022) %>% group_by(gas) %>% summarise(value=sum(value,na.rm=T))
sum(check$value)


### consistent names

newnames <- data_ghg %>% 
  ungroup() %>% 
  select(iso) %>% 
  distinct() %>% 
  mutate(newname=countrycode(iso,"iso3c","country.name")) %>% 
  mutate(newname=ifelse(iso=="AIR","Intl. Aviation",newname)) %>% 
  mutate(newname=ifelse(iso=="SEA","Intl. Shipping",newname)) %>% 
  mutate(newname=ifelse(iso=="SCG","Serbia and Montenegro",newname)) %>% 
  mutate(newname=ifelse(iso=="ANT","Netherlands Antilles",newname))

data_ghg <- left_join(data_ghg,newnames,by="iso") %>% 
  mutate(country=newname) %>% 
  select(-newname) %>% 
  filter(!is.na(iso))


### aggregate sectors

write.xlsx(data_ghg %>% ungroup() %>% select(code,code_description) %>% distinct() %>% arrange(code),"cc_sectors.xlsx")
data_ghg <- left_join(data_ghg,read.xlsx("sources/cc_sectors.xlsx"),by=join_by(code, code_description))

data_ghg$gas <- as.factor(data_ghg$gas)
data_ghg$gas <- fct_relevel(data_ghg$gas,"CO2 Fossil","CH4","N2O","Fgases")

data_ghg$subsector <- as.factor(data_ghg$subsector)
data_ghg$subsector <- fct_reorder(data_ghg$subsector,data_ghg$subsector_order)


data_ghg <- data_ghg %>% 
  mutate(year=as.numeric(year)) %>% 
  group_by(iso,country,sector,subsector,subsector_codes,gas,year) %>% 
  summarise(value=sum(value,na.rm=TRUE))


## Global Carbon Project CO2 LUC (https://globalcarbonbudget.org/carbonbudget2023/)

data_gcb_co2_luc <- load_gcb_countries_luc(
  readxl::read_xlsx('sources/National_LandUseChange_Carbon_Emissions_2023v1.0.xlsx',range="A8:GT182",sheet=2),
  readxl::read_xlsx('sources/National_LandUseChange_Carbon_Emissions_2023v1.0.xlsx',range="A8:GT182",sheet=3),
  readxl::read_xlsx('sources/National_LandUseChange_Carbon_Emissions_2023v1.0.xlsx',range="A8:GT182",sheet=4)
)
data_gcb_co2_luc$iso[grepl("TÃ¼rkiye",data_gcb_co2_luc$country)] <- "TUR"






```

``` {r figure_global_gases,fig.width=8,fig.height=4, fig.path="results/",dev=c('png','pdf','svg')}

## GHG emissions trend plot

plot_ghgs <- data_ghg %>% 
  filter(year>=1990) %>%
  group_by(gas,year) %>%
  summarise(value=sum(value,na.rm=TRUE)/1e9)


## replace land use emissions
plot_ghgs <- rbind(plot_ghgs,data_gcb_co2_luc %>% 
                      filter(year>=1990) %>% 
                      filter(country=="Global") %>% 
                      select(year,value=mean) %>% 
                      mutate(gas="CO2 LULUCF") %>% 
                      mutate(year=as.numeric(year)))


plot_ghgs$gas <- as.factor(plot_ghgs$gas)
plot_ghgs$gas <- fct_relevel(plot_ghgs$gas,"Fgases","N2O","CH4","CO2 LULUCF","CO2 Fossil")


plot_ghgs_totals <- plot_ghgs %>% 
  group_by(year) %>% 
  summarise(totals=sum(value))
  
line_data <- data.frame(x=c(1990,1990,2000,2000,2010,2010,2020,2020,2022,2022),y=c(0,60))


plot_ghgs %>% ggplot(aes(x=year,y=value,fill=gas)) +
  geom_area(color="#636363") +
  geom_line(inherit.aes = FALSE,data=line_data,aes(x=x,y=y,group=x),alpha=0.3,linetype="dashed") +
  geom_text(inherit.aes = FALSE, data=plot_ghgs_totals %>% filter(year %in% c(1990,2000,2010,2020,2022)),aes(x=ifelse(year==2022,year+0.5,year),y=63,label=paste(signif(totals,3))),
           size=3.5,colour="#252525") +
  theme_wl() +
  ylab("GHG Emissions (GtCO2e/year)") +
  scale_fill_manual(values=c("#e78ac3","#fc8d62","#8da0cb","#66c2a5","#a6d854")) +
  scale_x_continuous(breaks=c(1990,2000,2010,2020,2022)) +
  theme(axis.title.x = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.border = element_blank(),
        axis.line.x=element_line(colour='#636363'),
        axis.line.y=element_line(colour='#636363'),
        legend.position = "right",
        legend.title = element_blank())


```


``` {r figure_global_sectors,fig.width=8,fig.height=4, fig.path="results/",dev=c('png','pdf','svg')}

## GHG emissions trend plot

plot_sectors <- data_ghg %>% 
  filter(year>=1990) %>% 
  group_by(subsector,year) %>%
  summarise(value=sum(value,na.rm=TRUE)/1e9)


## replace land use emissions
plot_sectors <- rbind(plot_sectors,data_gcb_co2_luc %>% 
                      filter(year>=1990) %>% 
                      filter(country=="Global") %>% 
                      select(year,value=mean) %>% 
                      mutate(subsector="AFOLU: Land use") %>% 
                      mutate(year=as.numeric(year)))


plot_sectors <- left_join(plot_sectors,read.xlsx("sources/cc_sectors.xlsx",sheet=2),by="subsector")

plot_sectors$subsector <- as.factor(plot_sectors$subsector)
plot_sectors$subsector <- fct_reorder(plot_sectors$subsector,plot_sectors$position)


labels <- read.xlsx("sources/cc_sectors.xlsx",sheet=2)
labels <- labels %>% 
  arrange(desc(position)) %>% 
  mutate(position=1) %>% 
  mutate(position=cumsum(position))

labels$subsector <- fct_reorder(labels$subsector,labels$position)

  my_colours <- labels %>% select(subsector,colour)
  my_colours$subsector <- gsub("   ","",my_colours$subsector)
  my_colours <- left_join(plot_sectors %>%
                            ungroup() %>%
                            select(subsector) %>%
                            distinct() %>%
                            arrange(subsector),my_colours)
  
  

p1 <- plot_sectors %>% ggplot(aes(x=year,y=value,fill=subsector)) +
  geom_area(color="#636363") +
  theme_wl() +
  scale_fill_manual(values = my_colours$colour) +
  ylab("GHG Emissions (MtCO2e/year)") +
  theme(axis.title.x = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.border = element_blank(),
        axis.line.x=element_line(colour='#636363'),
        axis.line.y=element_line(colour='#636363'),
        legend.position = "none",panel.background = element_blank())


p2 <-  labels %>%  ggplot(.,aes(y=position,label=subsector)) +
    geom_point(aes(x=1.9,fill=subsector),
               shape=22,size=3,color='white') +
    geom_image(aes(x=2.4+str_length(subsector)/24,image=icons),by = "height",size=0.06)+ 
    geom_text(hjust=0,aes(x=2),color='#636363',vjust=0.5) +
    theme_wl() +
    scale_fill_manual(values = c(labels$colour)) +
    scale_x_continuous(limits=c(1.9,3.5)) +
    scale_y_continuous(limits=c(0.5,9.5),expand = c(0,0)) +
    theme(axis.title = element_blank(),
          panel.border = element_blank(),
          legend.position="none",
          axis.text.x = element_blank(),
          axis.text.y = element_blank(),
          axis.ticks = element_blank(),
          panel.grid.major = element_blank(),
          plot.title.position = "plot",
          plot.title = element_text(size=11,colour='#bdbdbd',hjust=1,face = "plain"),
          plot.background = element_blank(),
          plot.margin = unit(c(0,0,0,0),"cm"))

p1 + p2 + plot_layout(widths=c(4,2))

```
